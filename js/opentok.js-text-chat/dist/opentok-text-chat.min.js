(function(){var e,t,n,i,s,a,o,c,r={clientVersion:"js-vsol-1.0.0",componentId:"textChatAccPack",name:"guidTextChatAccPack",actionInitialize:"Init",actionSendMessage:"SendMessage",actionReceiveMessage:"ReceiveMessage",actionMaximize:"Maximize",actionMinimize:"Minimize",actionSetMaxLength:"SetMaxLength",variationAttempt:"Attempt",variationError:"Failure",variationSuccess:"Success"},d=function(){var e=window.location.href,i={clientVersion:r.clientVersion,source:e,componentId:r.componentId,name:r.name};n=new OTKAnalytics(i);var s={sessionId:t.id,connectionId:t.connection.connectionId,partnerId:t.apiKey};n.addSessionInfo(s)},m=function(e,t){var i={action:e,variation:t};n.logEvent(i)},l=!1,u=!1,v=!1,g=!1,h=function(e,t){c&&c.triggerEvent(e,t)},p=function(){return['<div class="wms-widget-wrapper">','<div class="wms-widget-chat wms-widget-extras" id="chatContainer">','<div class="wms-messages-header hidden" id="chatHeader">',"<span>Chat with</span>","</div>",'<div id="wmsChatWrap">','<div class="wms-messages-holder" id="messagesHolder">','<div class="wms-message-item wms-message-sent">',"</div>","</div>",'<div class="wms-send-message-box">','<input type="text" maxlength='+e.options.limitCharacterMessage+' class="wms-message-input" placeholder="Enter your message here" id="messageBox">','<button class="wms-icon-check" id="sendMessage" type="submit"></button>','<div class="wms-character-count"><span><span id="characterCount">0</span>/'+e.options.limitCharacterMessage+" characters</span></div>","</div>","</div>","</div>","</div>"].join("\n")},f=function(e){return!!a&&(a.sender.id===e.sender.id&&a.sender.id===e.sender.id)},x=function(){s.value="",$("#characterCount").text("0")},C=function(e){var t=['<div class="'+e.messageClass+'" >','<div class="wms-user-name-initial"> '+e.username[0]+"</div>",'<div class="wms-item-timestamp"> '+e.username+', <span data-livestamp=" '+new Date(e.time)+'" </span></div>','<div class="wms-item-text">',"<span> "+e.message+"</span>","</div>","</div>"].join("\n");return t},w=function(e,t,n,s){var a=i.id===e?"wms-message-item wms-message-sent":"wms-message-item",c=C({username:t,message:n,messageClass:a,time:s}),r=$(o);r.append(c),x(),r[0].scrollTop=r[0].scrollHeight},M=function(e){if(f(e)){$(".wms-item-text").last().append(["<span>",e.message,"</span>"].join(""));var t=$(o);t[0].scrollTop=t[0].scrollHeight,x()}else w(i.id,i.alias,e.message,e.sentOn);a=e,h("messageSent",e)},y=function(t){if(console.log(t.code,t.message),500===t.code){var n=_.template($("#chatError").html());$(e.comms_elements.messagesView).append(n())}h("errorSendingMessage",t)},S=function(e,n){var s=new $.Deferred,a={text:n,sender:{id:i.id,alias:i.alias},sentOn:Date.now()};return m(r.actionSendMessage,r.variationAttempt),void 0===e?t.signal({type:"text-chat",data:JSON.stringify(a)},function(e){if(e){var t="Error sending a message. ";m(r.actionSendMessage,r.variationFailure),413===e.code?t+="The chat message is over size limit.":500===e.code&&(t+="Check your network connection."),s.reject(_.extend(_.omit(e,"message")),{message:t})}else console.log("Message sent"),m(r.actionSendMessage,r.variationSuccess),s.resolve(a)}):t.signal({type:"text-chat",data:JSON.stringify(a),to:e},function(e){e?(console.log("Error sending a message"),s.resolve(e)):(console.log("Message sent"),s.resolve(a))}),s.promise()},T=function(t){_.isEmpty(t)||$.when(S(e._remoteParticipant,t)).then(function(){M({sender:{id:i.id,alias:i.alias},message:t,sentOn:Date.now()}),this.futureMessageNotice&&(this.futureMessageNotice=!1)},function(e){y(e)})},E=function(){var t=document.querySelector(e.options.textChatContainer)||document.body,n=document.createElement("section");n.innerHTML=p(),s=n.querySelector("#messageBox"),o=n.querySelector("#messagesHolder"),s.onkeyup=function(){$("#characterCount").text(s.value.length)},s.onkeydown=function(e){var t=13===e.which||13===e.keyCode;!e.shiftKey&&t&&(e.preventDefault(),T(s.value))},t.appendChild(n),document.getElementById("sendMessage").onclick=function(){T(s.value)},m(r.actionInitialize,r.variationSuccess)},I=function(e){m(r.actionReceiveMessage,r.variationAttempt);var t=JSON.parse(e.data);f(t)?$(".wms-item-text").last().append(["<span>",t.text,"</span>"].join("")):w(t.sender.id,t.sender.alias,t.text,t.sentOn),a=t,m(r.actionReceiveMessage,r.variationSuccess)},k=function(e){var n=t.connection.connectionId,i=e.from.connectionId;if(i!==n){var s=I(e);s&&"function"==typeof s&&s(e),h("messageReceived",e)}},A=function(){m(r.actionInitialize,r.variationAttempt),l=!0,u=!0,v=!0,E(),h("showTextChat"),t.on("signal:text-chat",k)},b=function(){m(r.actionMaximize,r.variationAttempt),document.querySelector(e.options.textChatContainer).classList.remove("hidden"),u=!0,h("showTextChat"),m(r.actionMaximize,r.variationSuccess)},z=function(){m(r.actionMinimize,r.variationAttempt),document.querySelector(e.options.textChatContainer).classList.add("hidden"),u=!1,h("hideTextChat"),m(r.actionMinimize,r.variationSuccess)},L=function(){var t=document.querySelector(e.options.controlsContainer),n=document.createElement("div");n.innerHTML='<div class="video-control circle text-chat enabled" id="enableTextChat"></div>';var i=n.firstChild;t.appendChild(i),g=!0,i.onclick=function(){v?u?z():b():A()}},j=function(e){if(!e.session)throw new Error("Text Chat Accelerator Pack requires an OpenTok session.");var n=function(e){var t=e||3;return Math.random().toString(36).substr(2,t)},s=function(){return[n(),t.id,n()].join("")};return t=_.property("session")(e),c=_.property("accPack")(e),i=_.defaults(e.sender||{},{id:s(),alias:["User",n()].join(" ")}),_.defaults(_.omit(e,["accPack","_sender"]),{limitCharacterMessage:160,controlsContainer:"#feedControls",textChatContainer:"#chatContainer"})},O=function(){var e=["showTextChat","hideTextChat","messageSent","errorSendingMessage","messageReceived"];c&&c.registerEvents(e)},q=function(){c&&(c.registerEventListener("startCall",function(){g?document.querySelector("#enableTextChat").classList.remove("hidden"):L()}),c.registerEventListener("endCall",function(){document.getElementById("enableTextChat").classList.add("hidden"),u&&z()}))},H=function(t){e=this,e.options=j(t),d(),_.property("_this.options.limitCharacterMessage")(t)&&(m(r.actionSetMaxLength,r.variationAttempt),m(r.actionSetMaxLength,r.variationSuccess)),L(),O(),q()};H.prototype={constructor:H,isEnabled:function(){return l},isDisplayed:function(){return u},showTextChat:function(){b()},hideTextChat:function(){z()}},"object"==typeof exports?module.exports=H:"function"==typeof define&&define.amd?define(function(){return H}):this.TextChatAccPack=H}).call(this);